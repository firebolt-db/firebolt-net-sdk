name: Release new version

on:
  workflow_dispatch:
    inputs:
      major-release:
        required: false
        description: 'Trigger a major release (optional). Leave empty for regular release.'

jobs:
  integration-tests:
    uses: ./.github/workflows/integration-tests.yml
    secrets:
      FIREBOLT_CLIENT_ID_STAGING_NEW_IDN: ${{ secrets.FIREBOLT_CLIENT_ID_STAGING_NEW_IDN }}
      FIREBOLT_CLIENT_SECRET_STAGING_NEW_IDN: ${{ secrets.FIREBOLT_CLIENT_SECRET_STAGING_NEW_IDN }}
      FIREBOLT_CLIENT_ID_DEV_NEW_IDN: ${{ secrets.FIREBOLT_CLIENT_ID_DEV_NEW_IDN }}
      FIREBOLT_CLIENT_SECRET_DEV_NEW_IDN: ${{ secrets.FIREBOLT_CLIENT_SECRET_DEV_NEW_IDN }}
    with:
      environment: dev
      branch: ${{ inputs.branch }}

  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: integration-tests
    steps:
      - name: Check out code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_PAT }}
          ref: ${{ inputs.branch }}

      - name: Setup git config
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"
        shell: bash

      - name: Set up Python 3.7
        uses: actions/setup-python@v2
        with:
          python-version: 3.7

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install argparse build semver twine
        shell: bash

      - name: Checkout release action repo
        uses: actions/checkout@v2
        with:
          repository: firebolt-db/action-python-release
          path: release_action

      - name: Generate new version tag
        id: tag_generation
        run: |
          OLD_TAG=$(git describe --tags --abbrev=0)
          OLD_VERSION=$(echo $OLD_TAG | cut -c 2-)
          echo "Old tag was ${OLD_TAG}"
          CHANGE_LOG=$(git log $OLD_TAG..HEAD --pretty=format:%s)
          NEW_VERSION=$(python3 release_action/scripts/generate_version_tag.py "${CHANGE_LOG}" $OLD_VERSION --major_release "${{ inputs.major-release }}")
          NEW_TAG="v"$NEW_VERSION
          echo "new_tag=$NEW_TAG" >>  $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >>  $GITHUB_OUTPUT
        shell: bash

      - name: Version bump
        run: |
          sed -i "s/^    <FileVersion>.*<\/FileVersion>/    <FileVersion>${{ steps.tag_generation.outputs.new_version }}<\/FileVersion>/" FireboltNETSDK/FireboltDotNetSdk.csproj
          sed -i "s/^    <AssemblyVersion>.*<\/AssemblyVersion>/    <AssemblyVersion>${{ steps.tag_generation.outputs.new_version }}<\/AssemblyVersion>/" FireboltNETSDK/FireboltDotNetSdk.csproj
          sed -i "s/^    <Version>.*<\/Version>/    <Version>${{ steps.tag_generation.outputs.new_version }}<\/Version>/" FireboltNETSDK/FireboltDotNetSdk.csproj
          git branch
          git diff
          git add FireboltNETSDK/FireboltDotNetSdk.csproj
          git commit -m "Automatic version bump to ${{ inputs.version }}"
          git push origin ${{ inputs.branch }}
        shell: bash

      - name: Publish tag on github
        run: |
          git tag ${{ inputs.version }}
          git push origin ${{ inputs.version }}
        shell: bash

      - name: Set up .NET 6.0
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 6.0

      - name: Build package
        run: |
          dotnet restore
          dotnet build
          dotnet pack
        shell: bash

      - name: Publish package on Nuget
        run: |
          dotnet nuget push FireboltNETSDK/bin/Debug/FireboltNetSDK.${{ inputs.version }}.nupkg \
            --api-key ${{ secrets.PUBLISH_API_KEY }} \
            --source https://api.nuget.org/v3/index.json
        shell: bash
